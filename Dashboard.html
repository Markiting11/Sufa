<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<title>School Dashboard</title>
<!-- Auth Guard Script: Isko head mein sabse pehle rakhen -->
<script>
    if (localStorage.getItem('isLoggedIn') !== 'true') {
        window.location.href = 'index.html';
    }
</script>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&family=Noto+Sans+Arabic:wght@400;700&display=swap" rel="stylesheet">
<style>
:root {
    --primary: #74ebd5;
    --secondary: #ACB6E5;
    --dark: #2c3e50;
    --accent: #ff8c00;
    --adm-theme: #34495e;
    --with-theme: #a93226;
    --ai-theme: #6c5ce7;
}

*{box-sizing:border-box;margin:0;padding:0;}

body {
    min-height:100vh;
    background: linear-gradient(135deg, #74ebd5 0%, #ACB6E5 100%);
    display:flex;
    justify-content:center;
    align-items:flex-start;
    padding:30px;
    font-family: 'Montserrat', 'Noto Sans Arabic', sans-serif;
}

.dashboard-container {
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
    border-radius: 30px;
    padding: 40px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    width: 100%;
    max-width: 1100px;
}

h1 {
    text-align: center;
    margin-bottom: 35px;
    font-weight: 800;
    font-size: 2.5rem;
    color: var(--dark);
    letter-spacing: -1px;
    text-transform: uppercase;
}

h1 a { text-decoration: none; color: inherit; }

.stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 40px;
}

.stat {
    color: #fff;
    border-radius: 20px;
    padding: 25px;
    text-align: center;
    transition: transform 0.3s ease;
    box-shadow: 0 8px 15px rgba(0,0,0,0.1);
}

.stat:hover { transform: translateY(-5px); }

.stat .count {
    display: block;
    font-size: 3rem;
    font-weight: 800;
    line-height: 1;
    margin-bottom: 5px;
    font-variant-numeric: tabular-nums;
}

.stat .label {
    font-size: 0.9rem;
    font-weight: 600;
    text-transform: uppercase;
    opacity: 0.9;
}

.stat.total { background: linear-gradient(135deg, #FF6B6B, #FF8E8E); }
.stat.active { background: linear-gradient(135deg, #4facfe, #00f2fe); }
.stat.withdrawn { background: linear-gradient(135deg, #43e97b, #38f9d7); }

.actions {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 40px;
}

.ai-tools-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 40px;
}

.ai-card {
    background: var(--ai-theme);
    color: white;
    padding: 20px;
    border-radius: 20px;
    text-decoration: none;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    transition: all 0.3s ease;
    border: none;
    cursor: pointer;
    box-shadow: 0 10px 20px rgba(108, 92, 231, 0.2);
}

.ai-card:hover { transform: translateY(-5px); filter: brightness(1.1); box-shadow: 0 15px 30px rgba(108, 92, 231, 0.3); }

.ai-card svg { width: 32px; height: 32px; margin-bottom: 10px; fill: currentColor; }
.ai-card span { font-weight: 700; font-size: 0.95rem; }

.action-btn {
    padding: 16px; border-radius: 15px; border: none; font-weight: 700; color: #fff;
    background: var(--dark); cursor: pointer; transition: all 0.2s; font-size: 1rem;
    text-align: center; text-decoration: none; display: inline-block;
}

.search-box { background: #fff; border-radius: 25px; padding: 30px; border: 1px solid #eee; }
.search-box h2 { margin-bottom: 20px; font-weight: 700; color: var(--dark); }
.search-controls { display: flex; gap: 10px; margin-bottom: 25px; }
.search-controls input { flex: 1; padding: 15px; border-radius: 12px; border: 2px solid #eee; font-size: 1rem; outline: none; }
.search-btn { background: var(--primary); color: #2c3e50; min-width: 120px; border: none; cursor: pointer; border-radius: 15px; font-weight: 700; }

@keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
.table-animate { animation: slideUp 0.5s ease forwards; }

table { width: 100%; border-collapse: separate; border-spacing: 0 8px; margin-top: 15px; }
th { text-transform: uppercase; font-size: 11px; font-weight: 700; padding: 12px; text-align: center; }
.adm-table th { color: var(--adm-theme); border-bottom: 2px solid var(--adm-theme); }
.adm-table td { background: #f0f4f8; color: var(--adm-theme); }
.with-table th { color: var(--with-theme); border-bottom: 2px solid var(--with-theme); }
.with-table td { background: #fdf2f2; color: var(--with-theme); }

td { padding: 15px 10px; text-align: center; font-size: 14px; font-weight: 600; }
tr td:first-child { border-radius: 10px 0 0 10px; }
tr td:last-child { border-radius: 0 10px 10px 0; }

#langSwitch {
    position: fixed; top: 20px; left: 20px; background: #fff; color: var(--dark);
    padding: 10px 20px; border-radius: 50px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    z-index: 100; border: none; cursor: pointer; font-weight: 600;
}

.download-btn {
    padding: 10px 15px; border-radius: 8px; font-size: 12px; background: var(--accent);
    margin-right: 5px; margin-bottom: 10px; border: none; color: white; cursor: pointer; font-weight: 700;
}

.section-title { margin: 25px 0 15px 0; font-size: 1.2rem; font-weight: 700; display: flex; align-items: center; gap: 10px; }
.slc-btn { padding: 6px 12px; font-size: 12px; color: #fff; border-radius: 6px; background: var(--adm-theme); border: none; cursor: pointer; }

.divider-title {
    width: 100%; text-align: left; border-bottom: 2px solid #eee; line-height: 0.1em;
    margin: 30px 0 20px; font-weight: 700; color: var(--dark); text-transform: uppercase; font-size: 0.8rem; letter-spacing: 1px;
}
.divider-title span { background:#fff; padding:0 10px; border-radius: 5px; }
body.rtl-mode .divider-title { text-align: right; }
</style>
</head>
<body>

<button id="langSwitch">اردو</button>

<div class="dashboard-container">
    <h1 id="title"><a href="Dashboard.html">School Dashboard</a></h1>
    
    <div class="stats">
        <div class="stat total">
            <span class="count" id="totalStudents">0</span>
            <span class="label" id="totalLabel">Total Students</span>
        </div>
        <div class="stat active">
            <span class="count" id="activeStudents">0</span>
            <span class="label" id="activeLabel">Active Students</span>
        </div>
        <div class="stat withdrawn">
            <span class="count" id="withdrawnStudents">0</span>
            <span class="label" id="withdrawnLabel">Withdrawn Students</span>
        </div>
    </div>

    <div class="divider-title"><span id="adminActionsLabel">Administrative Actions</span></div>
    <div class="actions">
        <a href="admission.html" id="newAdmissionBtn" class="action-btn">New Admission</a>
        <a href="withdraw.html" id="withdrawBtn" class="action-btn">Withdrawal Entry</a>
        <button id="logoutBtn" class="action-btn" style="background: #e74c3c; cursor:pointer;">Logout</button>
    </div>

    <div class="divider-title"><span id="aiToolsLabel">AI Academic Tools</span></div>
    <div class="ai-tools-grid">
        <a href="https://ai.studio/apps/drive/1vr1fep_emSImpw6d7JtzC6WPDY-F7Llo" target="_blank" class="ai-card">
            <svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zM6 20V4h7v5h5v11H6z"/></svg>
            <span id="toolPaperComposer">Paper Composer</span>
        </a>
        <a href="https://ai.studio/apps/drive/16a4Vs4IJl2ldewRRyx57wXY6q-sz3u8H" target="_blank" class="ai-card">
            <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-2 10h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"/></svg>
            <span id="toolQuestionSolver">Question Solver</span>
        </a>
        <a href="https://ai.studio/apps/drive/1SiwDPkXOuur_CkoMBWPsffvkU-3vx-RA" target="_blank" class="ai-card">
            <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
            <span id="toolPaperChecker">Paper Checker</span>
        </a>
    </div>

    <div class="search-box">
        <h2 id="searchTitle">Search Student</h2>
        <div class="search-controls">
            <input id="keyword" placeholder="Search by name, admission no, class...">
            <button class="search-btn" id="searchBtn" onclick="searchStudent()">Search</button>
        </div>

        <div class="section-title"><span id="activeListTitle">Active / Admissions</span></div>
        <button class="download-btn" onclick="downloadCSV('admissions')">CSV</button>
        <button class="download-btn" onclick="downloadPDF('admissions')">PDF</button>
        
        <div style="overflow-x: auto;">
            <table class="adm-table">
                <thead><tr id="admissionsHeaders"></tr></thead>
                <tbody id="admissionsBody"></tbody>
            </table>
        </div>

        <div class="section-title" style="margin-top:40px"><span id="withdrawalListTitle">Withdrawals</span></div>
        <button class="download-btn" onclick="downloadCSV('withdrawals')">CSV</button>
        <button class="download-btn" onclick="downloadPDF('withdrawals')">PDF</button>
        
        <div style="overflow-x: auto;">
            <table class="with-table">
                <thead><tr id="withdrawalsHeaders"></tr></thead>
                <tbody id="withdrawalsBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<script>
const SCRIPT_URL='https://script.google.com/macros/s/AKfycbysHurJbhdH0Cn8-1cQhWRCo13IIxN4R9U6LfUFIkqc8qnsT6boq0B4Ujj8nPT1xH75/exec';
let lang='en';
let admissionsData = [];
let withdrawalsData = [];

// Logout Functionality
document.getElementById('logoutBtn').onclick = () => {
    localStorage.removeItem('isLoggedIn');
    localStorage.removeItem('userEmail');
    window.location.href = 'index.html';
};

const txt={
  en:{
      title:'School Dashboard', total:'Total Students', active:'Active Students', withdrawn:'Withdrawn Students',
      search:'Search Student', btn:'Search', slc:'SLC', newAdmission:'New Admission', withdrawEntry:'Withdrawal Entry',
      logout:'Logout', activeList:'Active / Admissions', withdrawalList:'Withdrawals',
      admHeaders:['Adm No','Name','Father','Class','DOB','Adm Date','Status','Action'],
      withHeaders:['Adm No','Name','Class','Date','Reason'],
      adminActions: 'Administrative Actions', aiTools: 'AI Academic Tools',
      paperComposer: 'Paper Composer', questionSolver: 'Question Solver', paperChecker: 'Paper Checker'
  },
  ur:{
      title:'اسکول ڈیش بورڈ', total:'کل طلباء', active:'فعال طلباء', withdrawn:'خارج طلباء',
      search:'طالب علم تلاش کریں', btn:'تلاش', slc:'SLC', newAdmission:'نیا داخلہ', withdrawEntry:'خارج کریں',
      logout:'لاگ آؤٹ', activeList:'فعال طلباء', withdrawalList:'خارج شدہ طلباء',
      admHeaders:['داخلہ نمبر','نام','والد کا نام','کلاس','تاریخ پیدائش','تاریخ داخلہ','حیثیت','SLC'],
      withHeaders:['داخلہ نمبر','نام','کلاس','تاریخ','وجہ'],
      adminActions: 'انتظامی امور', aiTools: 'اے آئی تعلیمی ٹولز',
      paperComposer: 'پیپر کمپوزر', questionSolver: 'سوال حل کرنے والا', paperChecker: 'پیپر چیکر'
  }
};

const langSwitch=document.getElementById('langSwitch');
langSwitch.onclick=()=>{
  lang=lang==='en'?'ur':'en';
  document.body.dir=lang==='ur'?'rtl':'ltr';
  if(lang==='ur') document.body.classList.add('rtl-mode');
  else document.body.classList.remove('rtl-mode');
  langSwitch.innerText=lang==='en'?'اردو':'English';
  applyLang();
  renderAdmissions(admissionsData);
  renderWithdrawals(withdrawalsData);
};

function applyLang(){
  document.getElementById('title').querySelector('a').innerText=txt[lang].title;
  document.getElementById('totalLabel').innerText=txt[lang].total;
  document.getElementById('activeLabel').innerText=txt[lang].active;
  document.getElementById('withdrawnLabel').innerText=txt[lang].withdrawn;
  document.getElementById('searchTitle').innerText=txt[lang].search;
  document.getElementById('searchBtn').innerText=txt[lang].btn;
  document.getElementById('newAdmissionBtn').innerText = txt[lang].newAdmission;
  document.getElementById('withdrawBtn').innerText = txt[lang].withdrawEntry;
  document.getElementById('logoutBtn').innerText = txt[lang].logout;
  document.getElementById('activeListTitle').innerText = txt[lang].activeList;
  document.getElementById('withdrawalListTitle').innerText = txt[lang].withdrawalList;
  document.getElementById('adminActionsLabel').innerText = txt[lang].adminActions;
  document.getElementById('aiToolsLabel').innerText = txt[lang].aiTools;
  document.getElementById('toolPaperComposer').innerText = txt[lang].paperComposer;
  document.getElementById('toolQuestionSolver').innerText = txt[lang].questionSolver;
  document.getElementById('toolPaperChecker').innerText = txt[lang].paperChecker;
  document.getElementById('admissionsHeaders').innerHTML = txt[lang].admHeaders.map(h=>'<th>'+h+'</th>').join('');
  document.getElementById('withdrawalsHeaders').innerHTML = txt[lang].withHeaders.map(h=>'<th>'+h+'</th>').join('');
}

function formatDate(dateStr){
  if(!dateStr) return "";
  const d = new Date(dateStr);
  return String(d.getDate()).padStart(2,'0') + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + d.getFullYear();
}

async function loadDashboard(){
  const fd=new FormData(); fd.append('action','getDashboardStats');
  try {
      const r=await fetch(SCRIPT_URL,{method:'POST',body:fd});
      const d=await r.json();
      animateValue("totalStudents", 0, d.total || 0, 1000);
      animateValue("activeStudents", 0, d.active || 0, 1000);
      animateValue("withdrawnStudents", 0, d.withdrawn || 0, 1000);
  } catch(e) { console.error(e); }
}

function animateValue(id, start, end, duration) {
    const obj = document.getElementById(id);
    let startTimestamp = null;
    const step = (timestamp) => {
        if (!startTimestamp) startTimestamp = timestamp;
        const progress = Math.min((timestamp - startTimestamp) / duration, 1);
        obj.innerHTML = Math.floor(progress * (end - start) + start);
        if (progress < 1) window.requestAnimationFrame(step);
    };
    window.requestAnimationFrame(step);
}

function searchStudent(){
  const k=document.getElementById('keyword').value.trim();
  if(!k) return;
  const sBtn = document.getElementById('searchBtn');
  sBtn.innerText = '...';
  fetch(SCRIPT_URL,{method:'POST',body:new URLSearchParams({action:'searchStudent',keyword:k})})
  .then(r=>r.json()).then(d=>{
    sBtn.innerText = txt[lang].btn;
    admissionsData = d.admissions || [];
    withdrawalsData = d.withdrawals || [];
    renderAdmissions(admissionsData);
    renderWithdrawals(withdrawalsData);
  });
}

function renderAdmissions(l){
  const body = document.getElementById('admissionsBody');
  body.innerHTML='';
  if(!l.length){body.innerHTML='<tr><td colspan="8">No records found</td></tr>';return;}
  l.forEach((s, index)=>{
    const tr = document.createElement('tr');
    tr.className = 'table-animate';
    tr.style.animationDelay = (index * 0.05) + 's';
    tr.innerHTML = `
      <td>${s.admissionNo}</td>
      <td style="font-weight:700;">${s.studentName}</td>
      <td>${s.fatherName}</td>
      <td><span style="background:rgba(255,255,255,0.5); padding:4px 8px; border-radius:5px;">${s.class}</span></td>
      <td>${formatDate(s.dob)}</td>
      <td>${formatDate(s.admissionDate)}</td>
      <td><small>${s.status}</small></td>
      <td><button class="slc-btn" onclick="window.open('certificate-slc.html?admNo='+${s.admissionNo}+'&lang='+lang,'_blank')">${txt[lang].slc}</button></td>
    `;
    body.appendChild(tr);
  });
}

function renderWithdrawals(l){
  const body = document.getElementById('withdrawalsBody');
  body.innerHTML='';
  if(!l.length){body.innerHTML='<tr><td colspan="5">No records found</td></tr>';return;}
  l.forEach((s, index)=>{
    const tr = document.createElement('tr');
    tr.className = 'table-animate';
    tr.style.animationDelay = (index * 0.05) + 's';
    tr.innerHTML = `
      <td>${s.admissionNo}</td>
      <td style="font-weight:700;">${s.studentName}</td>
      <td>${s.class}</td>
      <td>${formatDate(s.withdrawalDate)}</td>
      <td>${s.reason||''}</td>
    `;
    body.appendChild(tr);
  });
}

function downloadCSV(type){
  const data = type==='admissions'?admissionsData:withdrawalsData;
  if(!data.length){ return; }
  let csvContent = "data:text/csv;charset=utf-8,";
  if(type==='admissions'){
    csvContent += txt[lang].admHeaders.slice(0,-1).join(',') + "\r\n";
    data.forEach(d=>{ csvContent += [d.admissionNo,d.studentName,d.fatherName,d.class,formatDate(d.dob),formatDate(d.admissionDate),d.status].map(v=>'"'+v+'"').join(',') + "\r\n"; });
  } else {
    csvContent += txt[lang].withHeaders.join(',') + "\r\n";
    data.forEach(d=>{ csvContent += [d.admissionNo,d.studentName,d.class,formatDate(d.withdrawalDate),d.reason||''].map(v=>'"'+v+'"').join(',') + "\r\n"; });
  }
  const link = document.createElement('a');
  link.setAttribute("href", encodeURI(csvContent));
  link.setAttribute("download", `${type}.csv`);
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

function downloadPDF(type){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p','pt','a4');
  const data = type==='admissions'?admissionsData:withdrawalsData;
  if(!data.length){ return; }
  const headers = type==='admissions'?txt[lang].admHeaders.slice(0,-1):txt[lang].withHeaders;
  let rows = [];
  if(type==='admissions'){
    data.forEach(d=>rows.push([d.admissionNo,d.studentName,d.fatherName,d.class,formatDate(d.dob),formatDate(d.admissionDate),d.status]));
  } else {
    data.forEach(d=>rows.push([d.admissionNo,d.studentName,d.class,formatDate(d.withdrawalDate),d.reason||'']));
  }
  doc.setFontSize(18);
  doc.text(type==='admissions'?'Admissions Report':'Withdrawals Report', 40, 45);
  doc.autoTable({ head:[headers], body:rows, startY:65, theme: 'grid', styles: {fontSize: 8} });
  doc.save(`${type}.pdf`);
}

applyLang();
loadDashboard();
</script>
</body>
</html>
